<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>订单确认</title>
    <script type="text/javascript" src="/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"/>
    <script th:inline="javascript">

        wx.config({
            debug: false,
            appId: [[${appId}]],
            timestamp: [[${timestamp}]],
            nonceStr: [[${nonceStr}]],
            signature: [[${signature}]],
            jsApiList: ['chooseWXPay', 'onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'onMenuShareQZone'] // 功能列表，我们要使用JS-SDK的什么功能
        });

        function orderPay() {
            ajax({
                url: "/pay/wechat.json",
                data: {
                    orderId: [[${orderId}]]
                },
                success: function (data) {
                    onBridgeReady(data.data);
                }
            })
        }

        function onBridgeReady(data) {
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest', {
                    appId: data.appId,     //公众号名称，由商户传入
                    timeStamp: data.timeStamp,         //时间戳，自1970年以来的秒数
                    nonceStr: data.nonceStr, //随机串
                    package: data.package,
                    signType: "MD5",         //微信签名方式：
                    paySign: data.paySign //微信签名
                },
                function (res) {
                    if (res.err_msg == "get_brand_wcpay_request:ok") {
                    }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
                    window.location.href = "/od/order/" + data.orderNumber + ".html"
                }
            );
        }
    </script>
</head>
<body>
<dev th:each="shopping:${list}">
    <input type="hidden" th:value="|${shopping.skuId},${shopping.count}|"/>
    <!--th:text="'商品编号:'+${shopping.skuId}"></>-->
    <p th:text="|商品名称:${shopping.name}|"></p>
    <p th:text="|商品单价:${shopping.price}|"></p>
    <p th:text="|数量:${shopping.count}|"></p>
    <p>-----------------------------</p>
</dev>

<a href="#" onclick="submit()">微信支付</a>
<script>
    function submit() {
        var params = new Array();
        $("input").each(function (index) {
            params[index] = $(this).val();
        })
        $.ajax({
            url: "/od/order/submit-pay.json",
            data: {
                sku: params
            },
            type: "POST",
            cache: false,
            dataType: "json",
            success: function (result) {
                if (result.success) {
                    onBridgeReady(data.data);
                } else {
                    alert(result.msg);
                }
            },
            error: function (msg) {
                alert("系统错误,请与管理员联系");
            }
        });
    }
</script>
</body>
</html>